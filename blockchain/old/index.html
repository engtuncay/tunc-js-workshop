<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JavaScript Blockchain Demo - Crypto-JS Edition</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Crypto-JS kÃ¼tÃ¼phanesini CDN'den yÃ¼kle -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  </head>
  <body>
    <h1>ğŸ”— JavaScript Blockchain Demo - Crypto-JS Edition</h1>
    <div class="crypto-info">
      <h3>ğŸ” Crypto-JS Ã–zellikleri</h3>
      <ul>
        <li>âœ… SHA-256 Hash AlgoritmasÄ±</li>
        <li>âœ… GerÃ§ek Kriptografik GÃ¼venlik</li>
        <li>âœ… GeliÅŸmiÅŸ Mining Ä°statistikleri</li>
        <li>âœ… Ä°ÅŸlem Hash'leri</li>
        <li>âœ… Otomatik Difficulty AyarÄ±</li>
      </ul>
    </div>

    <div class="container">
      <h2>BaÅŸlangÄ±Ã§ AyarlarÄ±</h2>
      <div>
        <button id="initializeBalancesBtn" class="init-btn">
          ğŸª™ BaÅŸlangÄ±Ã§ Bakiyelerini OluÅŸtur
        </button>
        <button id="quickMineBtn" class="mine-btn">
          âš¡ HÄ±zlÄ± Mining (Bakiye iÃ§in)
        </button>
      </div>
      <div id="initStatus"></div>
    </div>

    <div class="container">
      <h2>Yeni Ä°ÅŸlem OluÅŸtur</h2>
      <div>
        <input
          type="text"
          id="fromAddress"
          placeholder="GÃ¶nderen Adres"
          value="ahmet-wallet"
        />
        <input
          type="text"
          id="toAddress"
          placeholder="AlÄ±cÄ± Adres"
          value="mehmet-wallet"
        />
        <input type="number" id="amount" placeholder="Miktar" value="50" />
        <button id="createTransactionBtn">Ä°ÅŸlem OluÅŸtur</button>
      </div>
    </div>

    <div class="container">
      <h2>Mining & Difficulty</h2>
      <div>
        <input
          type="text"
          id="minerAddress"
          placeholder="Miner Adresi"
          value="miner1-wallet"
        />
        <input
          type="number"
          id="difficulty"
          placeholder="Difficulty (1-4)"
          value="2"
          min="1"
          max="4"
        />
        <button class="mine-btn" id="mineTransactionsBtn">
          Bekleyen Ä°ÅŸlemleri Mine Et
        </button>
        <button id="adjustDifficultyBtn">Difficulty Otomatik Ayarla</button>
      </div>
      <div id="miningStatus"></div>
      <div id="miningStats"></div>
    </div>

    <div class="container">
      <h2>Bakiye Sorgula</h2>
      <div>
        <input
          type="text"
          id="balanceAddress"
          placeholder="Adres"
          value="ahmet-wallet"
        />
        <button id="checkBalanceBtn">Bakiye Kontrol Et</button>
      </div>
      <div id="balanceResult"></div>
    </div>

    <div class="container">
      <h2>Bekleyen Ä°ÅŸlemler</h2>
      <button id="showPendingBtn">Bekleyen Ä°ÅŸlemleri GÃ¶ster</button>
      <div id="pendingTransactions"></div>
    </div>

    <div class="container">
      <h2>Blockchain Durumu</h2>
      <button id="displayBlockchainBtn">Blockchain'i GÃ¶ster</button>
      <button id="validateChainBtn">GeÃ§erliliÄŸi Kontrol Et</button>
      <button id="rebuildUtxoBtn">UTXO Set'i Yeniden OluÅŸtur</button>
      <div id="chainStatus"></div>
      <div id="blockchain"></div>
    </div>

    <script type="module">
      import { Block } from "./block-browser-crypto.js";
      import { Blockchain } from "./blockchain-browser-crypto.js";

      // Global blockchain instance
      const myBlockchain = new Blockchain();

      // Crypto-JS yÃ¼klenme kontrolÃ¼
      function checkCryptoJS() {
        if (typeof CryptoJS !== 'undefined') {
          console.log('âœ… Crypto-JS baÅŸarÄ±yla yÃ¼klendi');
          console.log('ğŸ” SHA-256 kullanÄ±labilir');
          
          // Test hash
          const testHash = CryptoJS.SHA256('test').toString();
          console.log('ğŸ§ª Test Hash:', testHash);
          
          return true;
        } else {
          console.error('âŒ Crypto-JS yÃ¼klenemedi!');
          alert('Crypto-JS yÃ¼klenemedi. Basit hash kullanÄ±lacak.');
          return false;
        }
      }

      // BaÅŸlangÄ±Ã§ bakiyelerini oluÅŸtur
      function initializeBalances() {
        const statusDiv = document.getElementById("initStatus");
        statusDiv.innerHTML = "<p>ğŸª™ BaÅŸlangÄ±Ã§ bakiyeleri oluÅŸturuluyor...</p>";

        // Ã–nceden tanÄ±mlÄ± adreslere baÅŸlangÄ±Ã§ miktarlarÄ± ver
        const initialBalances = [
          { address: "ahmet-wallet", amount: 1000 },
          { address: "mehmet-wallet", amount: 800 },
          { address: "ayse-wallet", amount: 600 },
          { address: "miner1-wallet", amount: 200 }
        ];

        try {
          // Her adres iÃ§in mining reward transaction'Ä± oluÅŸtur
          initialBalances.forEach(({ address, amount }) => {
            myBlockchain.createTransaction({
              fromAddress: null, // Mining reward
              toAddress: address,
              amount: amount
            });
          });

          // Otomatik mining yap
          const result = myBlockchain.minePendingTransactions("system-miner");
          
          statusDiv.innerHTML = `
            <div class="status valid">
              <strong>âœ… BaÅŸlangÄ±Ã§ bakiyeleri oluÅŸturuldu!</strong><br>
              Mining tamamlandÄ±: ${result.time}ms<br>
              Hash: ${result.hash}<br>
              ğŸª™ DaÄŸÄ±tÄ±lan bakiyeler:<br>
              ${initialBalances.map(b => `â€¢ ${b.address}: ${b.amount}`).join('<br>')}
            </div>
          `;

          displayBlockchain();
          displayMiningStats();
        } catch (error) {
          statusDiv.innerHTML = `
            <div class="status invalid">
              <strong>âŒ Hata:</strong> ${error.message}
            </div>
          `;
        }
      }

      // HÄ±zlÄ± mining (tek seferde birkaÃ§ blok)
      function quickMine() {
        const statusDiv = document.getElementById("initStatus");
        statusDiv.innerHTML = "<p>âš¡ HÄ±zlÄ± mining baÅŸlÄ±yor...</p>";

        try {
          // BirkaÃ§ mining reward transaction'Ä± oluÅŸtur
          for (let i = 0; i < 3; i++) {
            myBlockchain.createTransaction({
              fromAddress: null,
              toAddress: "miner1-wallet",
              amount: 100
            });
            
            const result = myBlockchain.minePendingTransactions("miner1-wallet");
            console.log(`Blok ${i + 1} mine edildi: ${result.hash}`);
          }

          statusDiv.innerHTML = `
            <div class="status valid">
              <strong>âš¡ HÄ±zlÄ± mining tamamlandÄ±!</strong><br>
              3 blok mine edildi<br>
              miner1-wallet adresine toplam 400 coin eklendi
            </div>
          `;

          displayBlockchain();
          displayMiningStats();
        } catch (error) {
          statusDiv.innerHTML = `
            <div class="status invalid">
              <strong>âŒ Mining hatasÄ±:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Event listener'lar ile fonksiyonlarÄ± baÄŸla
      function createTransaction() {
        const from = document.getElementById("fromAddress").value;
        const to = document.getElementById("toAddress").value;
        const amount = parseInt(document.getElementById("amount").value);

        if (!from || !to || !amount) {
          alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
          return;
        }

        try {
          myBlockchain.createTransaction({
            fromAddress: from,
            toAddress: to,
            amount: amount,
          });

          alert(`Ä°ÅŸlem oluÅŸturuldu: ${from} -> ${to}: ${amount}`);
          displayBlockchain();
          showPendingTransactions();
        } catch (error) {
          alert(`Hata: ${error.message}`);
        }
      }

      function mineTransactions() {
        const minerAddress = document.getElementById("minerAddress").value;
        const difficulty = parseInt(document.getElementById("difficulty").value) || 2;
        
        if (!minerAddress) {
          alert("LÃ¼tfen miner adresini girin!");
          return;
        }

        // Difficulty'yi gÃ¼ncelle
        myBlockchain.difficulty = difficulty;

        if (myBlockchain.pendingTransactions.length === 0) {
          alert("Mine edilecek bekleyen iÅŸlem yok!");
          return;
        }

        const statusDiv = document.getElementById("miningStatus");
        statusDiv.innerHTML = "<p>â›ï¸ Crypto-JS ile mining baÅŸlÄ±yor... LÃ¼tfen bekleyin.</p>";

        const mineBtn = document.getElementById("mineTransactionsBtn");
        mineBtn.disabled = true;
        mineBtn.textContent = "Mining yapÄ±lÄ±yor...";

        // Async mining
        setTimeout(() => {
          try {
            const result = myBlockchain.minePendingTransactions(minerAddress);
            statusDiv.innerHTML = `
              <div class="status valid">
                <strong>âœ… Crypto-JS Mining tamamlandÄ±!</strong><br>
                Hash: ${result.hash}<br>
                SÃ¼re: ${result.time}ms<br>
                Nonce: ${result.nonce}<br>
                Hash Rate: ${result.hashRate} hash/s<br>
                Toplam Deneme: ${result.attempts}
              </div>
            `;
            displayMiningStats();
            displayBlockchain();
            showPendingTransactions();
          } catch (error) {
            statusDiv.innerHTML = `
              <div class="status invalid">
                <strong>âŒ Mining hatasÄ±:</strong><br>
                ${error.message}
              </div>
            `;
          } finally {
            mineBtn.disabled = false;
            mineBtn.textContent = "Bekleyen Ä°ÅŸlemleri Mine Et";
          }
        }, 100);
      }

      function displayMiningStats() {
        const statsDiv = document.getElementById("miningStats");
        const stats = myBlockchain.miningStats;
        
        statsDiv.innerHTML = `
          <div class="mining-stats">
            <h4>ğŸ“Š Mining Ä°statistikleri</h4>
            <div><strong>Toplam Blok:</strong> ${stats.totalBlocks}</div>
            <div><strong>Ortalama Hash Rate:</strong> ${stats.averageHashRate} hash/s</div>
            <div><strong>Son Mining SÃ¼resi:</strong> ${stats.lastMiningTime}ms</div>
            <div><strong>Mevcut Difficulty:</strong> ${myBlockchain.difficulty}</div>
          </div>
        `;
      }

      function adjustDifficulty() {
        myBlockchain.adjustDifficulty();
        document.getElementById("difficulty").value = myBlockchain.difficulty;
        displayMiningStats();
        alert(`Difficulty ayarlandÄ±: ${myBlockchain.difficulty}`);
      }

      function showPendingTransactions() {
        const pendingDiv = document.getElementById("pendingTransactions");

        if (myBlockchain.pendingTransactions.length === 0) {
          pendingDiv.innerHTML = `
            <div class="status valid">
              ğŸ“­ Bekleyen iÅŸlem bulunmuyor.
            </div>
          `;
          return;
        }

        let html = `<h4>ğŸ“‹ Bekleyen Ä°ÅŸlemler (${myBlockchain.pendingTransactions.length} adet):</h4>`;

        myBlockchain.pendingTransactions.forEach((trans, index) => {
          html += `
            <div class="transaction">
              <strong>${index + 1}.</strong> 
              ${trans.fromAddress || "Mining Reward"} â†’ ${trans.toAddress}: 
              <strong>${trans.amount}</strong>
              ${trans.hash ? `<br><small>Hash: ${trans.hash}</small>` : ''}
            </div>
          `;
        });

        pendingDiv.innerHTML = html;
      }

      function checkBalance() {
        const address = document.getElementById("balanceAddress").value;
        if (!address) {
          alert("LÃ¼tfen adres girin!");
          return;
        }

        const balance = myBlockchain.getBalance(address);
        document.getElementById("balanceResult").innerHTML = `
          <div class="balance">
            <strong>${address}</strong> bakiye: <strong>${balance}</strong>
          </div>
        `;
      }

      function validateChain() {
        const isValid = myBlockchain.isChainValid();
        const statusClass = isValid ? "valid" : "invalid";
        const statusText = isValid
          ? "Blockchain geÃ§erli! (Crypto-JS)"
          : "Blockchain geÃ§ersiz!";

        document.getElementById("chainStatus").innerHTML = `
          <div class="status ${statusClass}">
            <strong>${statusText}</strong>
          </div>
        `;
      }

      function rebuildUtxo() {
        myBlockchain.rebuildUtxoSet();
        alert("UTXO Set yeniden oluÅŸturuldu!");
        displayBlockchain();
      }

      function displayBlockchain() {
        const blockchainDiv = document.getElementById("blockchain");
        let html = "<h3>Blockchain BloklarÄ± (Crypto-JS):</h3>";
        html += `<div><strong>Blockchain ID:</strong> ${myBlockchain.id}</div>`;
        
        // UTXO set bilgilerini gÃ¶ster
        if (myBlockchain.utxoSet.size > 0) {
          html += '<div class="utxo-info"><h4>ğŸ“Š UTXO Set (Optimize EdilmiÅŸ Bakiyeler):</h4>';
          for (const [address, balance] of myBlockchain.utxoSet.entries()) {
            html += `<div class="balance"><strong>${address}:</strong> ${balance}</div>`;
          }
          html += '</div>';
        }

        myBlockchain.chain.forEach((block, index) => {
          html += `
            <div class="block">
              <h4>Blok ${index} ${index === 0 ? '(Genesis)' : ''}</h4>
              <p><strong>Timestamp:</strong> ${new Date(block.timestamp).toLocaleString()}</p>
              <p><strong>Previous Hash:</strong> ${block.previousHash}</p>
              <p><strong>Hash:</strong> ${block.hash}</p>
              <p><strong>Nonce:</strong> ${block.nonce}</p>
              <div><strong>Data:</strong></div>
          `;

          if (Array.isArray(block.data)) {
            block.data.forEach((trans) => {
              html += `
                <div class="transaction">
                  ${trans.fromAddress || "Mining Reward"} â†’ ${trans.toAddress}: ${trans.amount}
                  ${trans.hash ? `<br><small>TX Hash: ${trans.hash}</small>` : ''}
                </div>
              `;
            });
          } else {
            html += `<div class="transaction">${block.data}</div>`;
          }

          html += "</div>";
        });

        blockchainDiv.innerHTML = html;
      }

      // Event listener'larÄ± ekle
      document.getElementById("initializeBalancesBtn").addEventListener("click", initializeBalances);
      document.getElementById("quickMineBtn").addEventListener("click", quickMine);
      document.getElementById("createTransactionBtn").addEventListener("click", createTransaction);
      document.getElementById("mineTransactionsBtn").addEventListener("click", mineTransactions);
      document.getElementById("adjustDifficultyBtn").addEventListener("click", adjustDifficulty);
      document.getElementById("checkBalanceBtn").addEventListener("click", checkBalance);
      document.getElementById("showPendingBtn").addEventListener("click", showPendingTransactions);
      document.getElementById("displayBlockchainBtn").addEventListener("click", displayBlockchain);
      document.getElementById("validateChainBtn").addEventListener("click", validateChain);
      document.getElementById("rebuildUtxoBtn").addEventListener("click", rebuildUtxo);

      // Sayfa yÃ¼klendikten sonra baÅŸlat
      document.addEventListener('DOMContentLoaded', function() {
        console.log("ğŸš€ Crypto-JS Blockchain demo baÅŸlatÄ±lÄ±yor...");
        
        // Crypto-JS kontrolÃ¼
        const cryptoAvailable = checkCryptoJS();
        
        console.log("ğŸ“¦ Block sÄ±nÄ±fÄ± yÃ¼klendi:", typeof Block);
        console.log("ğŸ”— Blockchain sÄ±nÄ±fÄ± yÃ¼klendi:", typeof Blockchain);
        
        displayBlockchain();
        validateChain();
        showPendingTransactions();
        displayMiningStats();
      });
    </script>
  </body>
</html>